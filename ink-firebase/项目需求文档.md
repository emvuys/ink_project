# INK NFS 后端系统 - 项目需求文档

## 项目概述

本项目旨在为 INK 构建一个完整的 NFS（近场签名）后端系统，这是一个加密验证层，为 INK 的配送认证提供支持。系统包括 REST API、面向客户的网页和实时追踪集成。

**核心目标**：为奢侈品商家提供使用 NFC 标签、GPS 验证和加密证明来验证包裹配送的能力。

---

## 工作范围

### 1. REST API 开发

#### 1.1 POST /enroll - 注册包裹
- **功能**：接收来自 Shopify 的配送前数据
- **接收数据**：
  - `order_id` - 订单ID
  - `nfc_uid` - NFC标签唯一标识符
  - `nfc_token` - NFC令牌
  - `photo_urls[]` - 照片URL数组（4张）
  - `photo_hashes[]` - 照片SHA-256哈希数组
  - `shipping_address_gps` - 配送地址GPS坐标
  - `customer_phone_last4` - 客户手机号后4位
  - `warehouse_gps` - 仓库GPS坐标
  - `timestamp` - 时间戳
- **处理流程**：
  1. 生成 `proof_id` 并存储注册记录
  2. 使用 Ed25519 私钥对数据进行签名
  3. 返回：`proof_id`、`enrollment_status`、`key_id`

#### 1.2 POST /verify - 验证配送
- **功能**：接收客户点击NFC标签时的配送数据
- **接收数据**：
  - `nfc_token` - NFC令牌
  - `delivery_gps` - 配送GPS坐标
  - `timestamp` - 时间戳
  - `device_info` - 设备信息
  - `phone_last4` - 手机号后4位（可选）
- **验证规则**：
  - **距离 ≤ 100米**：自动验证，无需手机验证
  - **距离 100-300米**：需要手机验证
  - **距离 > 300米**：需要手机验证
- **处理流程**：
  1. 计算配送GPS与配送地址GPS之间的距离
  2. 根据距离应用验证规则
  3. 如需要，验证手机号后4位
  4. 使用私钥对配送事件进行签名
  5. 发送HMAC签名的webhook到Shopify
- **返回数据**：
  - `proof_id` - 证明ID
  - `verification_status` - 验证状态
  - `gps_verdict` - GPS判定（pass/near/flagged）
  - `signature` - 签名
  - `verify_url` - 验证URL

#### 1.3 GET /retrieve/{proof_id} - 查询证明
- **功能**：返回完整的证明记录
- **返回数据**：
  - 注册数据（照片、仓库GPS、时间戳等）
  - 配送数据（配送GPS、时间戳、设备信息、GPS判定等）
  - 签名和公钥
- **用途**：供Shopify应用和争议解决页面使用

#### 1.4 GET /.well-known/jwks.json - 公钥暴露
- **功能**：以JWKS格式暴露公钥，用于签名验证

---

### 2. 客户点击体验页面

#### 2.1 页面地址
- `https://in.ink/t/{token}`

#### 2.2 功能要求
- **NFC点击加载**：从URL提取token
- **GPS获取**：通过浏览器地理定位API请求GPS权限
- **距离计算**：计算到配送地址的距离
- **自动验证场景**（距离 ≤ 100米）：
  - 显示成功动画（彩纸效果）
  - 显示4张配送前照片
  - 显示"配送已确认"消息
- **需要验证场景**（距离 > 100米或GPS被拒绝）：
  - 提示输入手机号后4位
  - 验证后显示成功
- **显示信息**：
  - 时间戳
  - 大致位置
  - "查看完整证明"按钮
- **错误处理**：
  - 无效token
  - 已验证
  - 网络故障

#### 2.3 设计要求
- 移动优先响应式设计（iOS Safari、Android Chrome）
- INK品牌风格（黄色强调色、简约美学）
- 快速加载时间
- 优雅的GPS失败处理

---

### 3. 争议解决页面

#### 3.1 页面地址
- `https://in.ink/verify/{proof_id}`

#### 3.2 显示内容
- 掩码订单ID、证明ID
- 4张配送前照片（带proof_id水印）
- 配送时间戳、大致GPS位置
- GPS判定徽章（已验证/接近地址/已标记）
- 设备信息
- 加密签名及验证说明
- "由INK验证"徽章

#### 3.3 要求
- 公开访问，无需认证
- SEO友好、打印友好布局
- 分享/复制功能

---

### 4. 实时包裹追踪

#### 4.1 集成要求
- **Bluedot.io SDK集成**：基于接近度的通知
- **承运商API集成**：UPS、FedEx、USPS追踪
- **地理围栏触发**：在客户配送地址周围设置地理围栏触发器

#### 4.2 推送通知
在以下接近里程碑发送推送通知：
- "30分钟到达"
- "10分钟到达"
- "5分钟到达"
- "包裹已到达"

#### 4.3 交付物
- Bluedot.io SDK集成
- 推送通知系统（Firebase/APNs或SMS/邮件备用）
- 承运商API集成
- 实时位置端点供Shopify查询包裹状态
- 追踪实现文档

---

### 5. Shopify Webhook集成

#### 5.1 Webhook端点
- **URL**：POST到Shopify端点（由Taimoor提供）
- **触发时机**：验证成功后

#### 5.2 载荷格式
```json
{
  "order_id": "SHOP-12345",
  "status": "verified",
  "delivery_gps": {...},
  "gps_verdict": "pass",
  "proof_ref": "proof_xyz789",
  "timestamp": "...",
  "verify_url": "https://in.ink/verify/proof_xyz789"
}
```

#### 5.3 安全性
- 使用HMAC-SHA256对载荷进行签名
- 在 `X-INK-Signature` 头中包含签名
- 失败时重试3次，使用指数退避

---

### 6. 数据库实现

#### 6.1 数据表结构（proofs表）
- **基础字段**：`proof_id`、`order_id`、`nfc_uid`、`nfc_token`
- **注册数据**：时间戳、配送地址GPS、仓库GPS、照片URL/哈希、客户手机号后4位
- **配送数据**：时间戳、配送GPS、设备信息、GPS判定、手机验证状态
- **加密数据**：签名、`key_id`
- **索引**：`nfc_token`、`order_id`、`proof_id`

---

### 7. 加密实现

#### 7.1 密钥管理
- 为服务生成一个长期Ed25519密钥对
- 将私钥安全存储（环境变量）
- 通过JWKS端点暴露公钥

#### 7.2 签名生成
- **注册数据签名**：`order_id` + `nfc_uid` + `photo_hashes` + `shipping_address_gps` + `timestamp`
- **配送数据签名**：注册数据 + `delivery_gps` + `timestamp` + `device_info` + `gps_verdict`
- 使用规范JSON表示以确保确定性签名

---

### 8. 安全与隐私

#### 8.1 安全要求
- 所有端点仅使用HTTPS
- 静态存储数据使用AES-256加密
- 速率限制：每个IP每小时100个请求
- 仅存储手机号后4位
- 在公共页面上显示大致GPS位置（非精确坐标）
- 所有端点的输入清理和验证
- 为点击页面配置CORS
- 对外发webhook进行HMAC验证

---

### 9. 部署

#### 9.1 Docker部署
- Dockerized应用程序，带`docker-compose.yml`
- PostgreSQL数据库（或首选数据库）
- 环境变量配置（私钥、数据库URL、webhook端点、API凭证）
- SSL证书配置
- 初始部署在云服务器上（稍后迁移到生产域名）

#### 9.2 监控
- 请求/错误日志记录
- Webhook失败日志记录
- 健康检查端点：`GET /health`

---

### 10. 文档要求

#### 10.1 必需交付物
- 所有API端点的OpenAPI/Swagger规范
- 每个端点的示例请求和响应
- 部署指南（Docker设置、环境变量、数据库初始化、SSL配置）
- Shopify开发者集成指南（API调用、HMAC签名/验证示例）
- 签名验证指南（如何独立验证加密签名）
- Bluedot集成文档

---

### 11. 测试要求

#### 11.1 测试场景
- **正常流程**：注册 → 客户在正确地址点击 → 自动验证
- **GPS距离场景**：在150米处点击需要手机，在600米处点击需要手机
- **手机验证**：正确的后4位验证通过，错误显示错误，3次尝试限制
- **错误处理**：无效token、GPS被拒绝、网络超时、已验证标签
- **安全性**：HMAC验证、速率限制、签名验证
- **Bluedot追踪**：接近警报在正确距离触发
- **Webhook可靠性**：Shopify接收验证更新，重试逻辑有效

---

## 里程碑与预算

### Milestone 1: 核心API和数据库 - $900
- ✅ POST /enroll端点
- ✅ POST /verify端点
- ✅ GET /retrieve/{proof_id}端点
- ✅ GET /.well-known/jwks.json
- ✅ 数据库架构（proofs表）
- ✅ Ed25519加密签名实现
- ✅ Docker部署配置
- **交付物**：API可在测试服务器上访问，准备进行Taimoor的集成测试

### Milestone 2: 客户点击页面 - $900
- ✅ 公共网页：`https://in.ink/t/{token}`
- ✅ GPS捕获（浏览器地理定位API）
- ✅ 距离计算
- ✅ 手机后4位验证流程（距离>100米时）
- ✅ 成功动画 + 显示4张配送前照片
- ✅ 错误处理
- ✅ 移动响应式设计，INK品牌
- **交付物**：可工作的点击页面，调用/verify并显示结果

### Milestone 3: 争议页面和Webhook - $700
- ✅ 公共网页：`https://in.ink/verify/{proof_id}`
- ✅ 显示注册数据（照片、仓库GPS、时间戳）
- ✅ 显示配送数据（配送GPS、时间戳、设备信息、GPS判定）
- ✅ 显示加密签名及验证说明
- ✅ HMAC签名的webhook到Shopify端点：POST /ink/update
- ✅ Webhook重试逻辑（3次，指数退避）
- **交付物**：完整的争议页面 + 与Taimoor测试的webhook集成

### Milestone 4: Firebase/Bluedot和文档 - $500
- ✅ Firebase云消息传递集成（推送通知）
- ✅ Bluedot.io SDK集成（实时包裹追踪）
- ✅ 承运商API集成（UPS/FedEx/USPS追踪）
- ✅ 接近里程碑推送通知
- ✅ 完整API文档（OpenAPI/Swagger规范）
- ✅ 部署指南
- ✅ Taimoor集成指南
- **交付物**：带追踪的完整系统 + 所有文档

**总预算：$3,000**

---

## 时间线

### 关键截止日期
- **关键截止日期**：API必须在Taimoor的Phase 1结束时准备好（从他开始日期起约2-3周）

### 建议阶段
- **Phase 1（第1-2周）**：REST API、数据库、加密签名、基本测试
- **Phase 2（第2-3周）**：客户点击页面、争议页面、webhook集成
- **Phase 3（第3-4周）**：Bluedot集成、实时追踪、推送通知
- **Phase 4（第4周）**：端到端测试、文档、部署

---

## 依赖与协调

### 将收到的内容
- Taimoor的Shopify webhook端点URL
- HMAC共享密钥（用于webhook签名）
- Bluedot.io API凭证
- 推送通知服务凭证（Firebase或Twilio）
- `in.ink`域名配置
- 承运商API访问凭证（如需要）

### 将提供给Taimoor
- API文档和端点URL
- 测试环境访问
- HMAC共享密钥（用于webhook验证）
- 用于集成测试的示例注册和验证载荷

### 协调
- 每周进度检查
- 与Taimoor的共享测试阶段，进行端到端验证

---

## 交付清单

- ✅ REST API套件（/enroll、/verify、/retrieve、/jwks.json）
- ✅ 客户点击页面（`https://in.ink/t/{token}`）
- ✅ 争议解决页面（`https://in.ink/verify/{proof_id}`）
- ✅ HMAC签名的webhook到Shopify
- ✅ Bluedot.io地理围栏集成
- ✅ 带推送通知的实时追踪
- ✅ 数据库架构和实现
- ✅ Ed25519加密签名系统
- ✅ 基于GPS的验证逻辑
- ✅ Docker部署包
- ✅ 完整API文档
- ✅ 所有场景的测试验证

---

## 技术栈

- **后端**：Node.js + Express.js
- **数据库**：Firebase Cloud Firestore（NoSQL文档数据库）
- **加密**：Ed25519签名算法
- **Webhook安全**：HMAC-SHA256
- **照片哈希**：SHA-256
- **部署**：Docker
- **追踪**：Bluedot.io SDK
- **推送通知**：Firebase Cloud Messaging

---

## 当前项目状态

根据代码库分析，**Milestone 1（核心API和数据库）** 已经基本完成：

✅ **已实现的功能**：
- POST /enroll端点
- POST /verify端点
- GET /retrieve/{proof_id}端点
- GET /.well-known/jwks.json端点
- Firebase Firestore数据库集成
- Ed25519加密签名实现
- GPS距离计算和验证逻辑
- HMAC-SHA256 webhook签名
- 开发环境请求日志
- 完整的错误处理和日志记录

⏳ **待完成的功能**：
- Milestone 2: 客户点击体验页面
- Milestone 3: 争议解决页面和Shopify webhook接收
- Milestone 4: Bluedot集成、实时追踪、完整文档

---

## 总结

这是一个完整的配送验证系统，通过NFC标签、GPS验证和加密证明为奢侈品商家提供可靠的包裹配送认证。系统采用现代化的技术栈，注重安全性和用户体验，旨在为商家和客户提供无缝的配送验证体验。

